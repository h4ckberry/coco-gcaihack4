1. システムアーキテクチャ概要イベント駆動型のサーバーレスアーキテクチャを採用する。(ここに以前作成した、変化検知付きイベント駆動アーキテクチャ図 [image_5.png] を参照挿入)Frontend: Next.js (Firebase Hosting) on iOS Device. 定期的な画像アップロードとユーザーインターフェースを担当。Trigger: Cloud Storageへの画像保存をトリガーに、Eventarcが軽量なチェック関数(Cloud Functions Gen2)を起動。Core Backend (本ドキュメントの対象): Cloud Run上で動作するPythonアプリケーション。変化検知を通過したリクエスト、またはユーザーからの直接のクエリを受け、AIエージェント群を統括する。Database: Firestore。エージェントの記憶（長期メモリ）と会話履歴を保持。Physical API: obniz Cloud API。モーター制御命令を受け付ける。2. 技術スタック (Backend Core)Runtime: Python 3.11+ (Containerized on Cloud Run)Web Framework: FastAPI または Google Functions Framework for Python (HTTPリクエスト処理用)AI SDK: Google Gen AI Agent Development Kit (ADK)AI Models: Vertex AI Gemini 1.5 Pro & Gemini 1.5 FlashVoice API: Google Cloud Text-to-Speech APIDB Client: Firebase Admin SDK (Firestore接続用)IoT Client: obniz SDK for Python または requests によるREST APIコール3. AI エージェント設計 (ADK Implementation)ADKを用い、責務を分離したマルチエージェント構成とする。3.1. エージェント構成図(ここに以前作成したマルチエージェント関係図 [image_7.png] を参照挿入)3.2. 各エージェントの定義とToolAgent RoleModel Selection役割と実装Tool例1. Orchestrator(司令塔)Gemini 1.5 Proユーザー意図理解、ルーティング、最終回答生成。- Tool: 他の全エージェントを呼び出す関数2. Context Historian(記憶係)Gemini 1.5 FlashFirestoreの過去ログ検索・記録。- Tool: search_firestore(query, time_range), log_observation(object, location)3. Causal Detective(推論係)Gemini 1.5 Pro消失原因や因果関係の高度な推論。- Tool: (主に推論能力のみ利用、特別なToolは不要な場合も)4. Realtime Observer(監視係)Gemini 1.5 Flash最新画像の物体検知。- Tool: analyze_latest_image(target_object)5. Physical Explorer(探索係)Gemini 1.5 Flashモーター制御。- Tool: rotate_motor(angle)3.3. ワークフロー制御 (Orchestration)ADK自体はワークフローエンジンではないため、Pythonのコード（Orchestratorのロジック内）で、状況に応じて適切な専門エージェントを順次、あるいは並行して呼び出す手続き型のフローを実装する。最終的な回答は、Orchestratorがテキストを生成した後、Cloud TTS APIを通して音声データ化し、フロントエンドへ返却する。4. データモデル (Firestore)observations コレクション: エージェントが視界内で「重要だ」と認識した物体の記録。RAGのソースとなる。JSON{
  "timestamp": "2024-01-01T10:00:00Z",
  "object_name": "car_keys",
  "location_description": "on the coffee table, near the red mug",
  "image_snapshot_url": "gs://...", // 該当瞬間の切り抜き画像など（オプション）
  "confidence": 0.95
}
conversation_history コレクション: ユーザーとの対話履歴。文脈維持用。5. インフラとコスト管理設定 (必須事項)Firebaseプラン: Blaze (従量課金) プランが必須。Cloud Storage ライフサイクル設定: バケットに対し、「作成から2時間（または適切な短い期間）経過したオブジェクトを自動削除」するルールを設定する。これによりストレージ料金の爆発を防ぐ。